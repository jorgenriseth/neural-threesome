# Neural Threesome 
This repository contains a reduced collection of files from the repository https://github.com/holzhauk/neural-threesome, which were used in a project during the Simula Summer School of Computational Physiology in 2022. The old repository contained several pieces of code which we inherited from older projects, which were no longer of interest. However, since we developed a few pieces of code of interest to me, especially related to mixed-dimensional problems in FEniCS, I have created this smaller repository for reference. 

**NOTE:** Since this is a reduced collection of files kept mainly for reference, no work has been done to ensure that the scripts are functional, and several of them will have some missing dependencies. 
---
---
# (Legacy Readme Below)
## Computational Modelling of Synapse-Glia-Interaction

[KNP-EMI model](https://zenodo.org/record/3492075#.YrypFi8RphB)


## Creating Meshes
The synapse meshes may be created using the `make_mesh_from_geo.py`. The script turns `.geo`-files (located in the `resources` folders) into h5-files with the mesh and meshfunctions defining subdomains and different boundaries.

Example usage:
```bash
./make_mesh_from_geo.py resources/dendrites.geo mesh/dendrites.h5 --tmpdir tmp --cell_size 0.1
```
The `--tmpdir` argument is optional, and stores intermediate `.xdmf`-files in the given directory. This is useful to visualize the mesh in e.g. paraview.

After creation mesh with subdomains and boundaries may be imported in python using
```python
from meshprocessing import hdf2fenics

mesh, subdomain, boundaries = hdf2fenics("mesh/dendrites.h5")
...
```
or whatever mesh you want to use.

### Direct Creation
Alternatively, its possible to run the mesh generation functions directly in the notebook. See example usage in `notebooks/example-mesh-import.ipynb`,

------------------------------------------------------------------------------

## KNP-EMI Documentation
Project description
------------------------------------------------------------------------------
This directory contains an implementation of a Mortar element FEM method
for the solving the KNP-EMI model and the EMI model.

------------------------------------------------------------------------------
Dependencies
------------------------------------------------------------------------------

To get the environment needed (all dependencies etc.) to run the code, build 
the fenics docker image and install all aditional python dependencies by
running:

### Intel based architectures
```bash
docker build -t fenics-md .
```

### Arm based Macs
```bash
docker build --platform linux/arm64 -t fenics-md .
```

**NB: Run the following command from within the neural-threesome folder.**

Start the container and link the repository by running the command

```bash
docker run -p 8080:8080 -v $(pwd):/home/fenics/neural-threesome/ -it fenics-md
```

To run a jupyter notebook (or lab) from within the container, execute 
```bash
jupyter notebook --port 8080 --ip 0.0.0.0
```

Alternatively:

```bash
singularity shell docker://ceciledc/fenics_mixed_dimensional:20-02-19
```

All meshes are generates automatically in the code where they are used, if they
do not already exist.

------------------------------------------------------------------------------
Running the code
------------------------------------------------------------------------------
To run all the numerical experiments, execute:

$ python main.py

Each numerical experiments can be run by the run_*.py files, i.e. to run the
method of manufactured solutions test, execute:
```
$ python run_MMM_test.py
```
------------------------------------------------------------------------------
Generate figures
------------------------------------------------------------------------------
To generate the figures (.svg format) presented in the paper, execute:
```bash
$ make_figures.py
```
and to convert the .svg figures to .pdf figures, execute:
```bash
$ convert_figures.py
```
------------------------------------------------------------------------------
Files
------------------------------------------------------------------------------
main.py:
    Script for running all simulations presented in paper, that is:
    - run_refinement_test.py
    - run_test_MMS.py
    - run_2D_axonspy
    - run_3D_axonbundle.py

    In addition, the script generates figures (as in the paper) in .svg format:
    - make_figures.py 
    and converts the figures to .pdf and .pdf_latex format:
    - convert.sh

run_refinement_test.py:
    Run convergence test using refined 2D meshes with one neuron
    - mesh generated by 'make_mesh_refinement_test.py'

run_MMS_test.py:
    Run method of manufactured solutions (MMS) test on unit square
    - mesh generated by 'make_mesh_MMS.py'

run_2D_axons.py:
    Run simulations to compare the EMI and the KNP-EMI model on mesh with one
    and two intracellular compartment
    - mesh generated by 'make_mesh_one_neuron_2D.py'
    - mesh generated by 'make_mesh_two_neurons_2D.py'
    - mesh generated by 'make_mesh_two_neurons_wide_2D.py'

run_3D_axonbundle.py:
    Run physiological simulation to explore ephaptic coupling in idealized
    3D neuron bundle mesh
    - mesh generated by 'make_mesh_axonbundle_3D.py'

solver.py:
    Contains class for a FEM solver for the KNP-EMI problem

solver_emi.py:
    Contains class for a FEM solver for the EMI problem

utils.py:
    Contains class for setting up exact solutions, boundary terms, source terms
    and initial conditions for the method of manufactured solutions (MMS) test.

make_mesh_refinement.py:
    Generates meshes for refinement test (run_refinement_test.py)

make_mesh_one_neuron_2D.py:
    Generates meshes of the MMS test (run_MMS_test.py)

make_mesh_two_neurons_2D.py:
    Generates meshes of a 2D axon (run_2D_axons.py)

make_mesh_two_neurons_wide_2D.py:
    Generates meshes of a 2D axon (run_2D_axons.py)

make_mesh_axonbundle_3D.py
    Generates meshes of a 3D axonbundle with 9 axons (run_3D_axons.py)

make_figures.py
    generates figures displaying results from simulations in .svg format

convert_figures.sh
    convert .svg figures generated by make_figures.py to .pdf and .pdf_tex figures
